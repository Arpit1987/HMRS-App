name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai_review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > diff.txt

      - name: Call HuggingFace Inference API
        run: |
          BODY=$(jq -Rs '{inputs: .}' diff.txt)

          curl -s \
            -X POST \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            https://api-inference.huggingface.co/models/tiiuae/falcon-7b-instruct \
            > review.json

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REVIEW=$(jq -r '.[0].generated_text' review.json)
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "### ðŸ¤– AI Review\n$REVIEW"
